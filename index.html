<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Uber Jnr | Boutique Premium Puff Troyes ‚ö°</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200;0,400;0,600;0,800;1,800&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, push, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDNAAwvuIxB_7nv8y_E9lXjbPoZNUH3gvE",
            authDomain: "uber-jnr-3d606.firebaseapp.com",
            projectId: "uber-jnr-3d606",
            databaseURL: "https://uber-jnr-3d606-default-rtdb.europe-west1.firebasedatabase.app/",
            storageBucket: "uber-jnr-3d606.firebasestorage.app",
            messagingSenderId: "832058251203",
            appId: "1:832058251203:web:0b319e5493826e16f3cf76"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        window.db = db;
        window.fb = { ref, set, onValue, update, remove, push, get };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <style>
        :root {
            --u-green: #22c55e;
            --u-black: #000000;
            --u-card: #080808;
            --u-border: rgba(255, 255, 255, 0.08);
            --font-main: 'Plus Jakarta Sans', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--u-black); color: #fff; font-family: var(--font-main); overflow-x: hidden; }

        /* --- ANIMATIONS --- */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        @keyframes glow { 0% { box-shadow: 0 0 5px var(--u-green); } 50% { box-shadow: 0 0 20px var(--u-green); } 100% { box-shadow: 0 0 5px var(--u-green); } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* --- SPLASH SCREEN --- */
        #splash { position: fixed; inset: 0; background: #000; z-index: 999999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .splash-text { font-size: 4rem; font-weight: 800; font-style: italic; animation: float 3s ease-in-out infinite; }

        /* --- MARQUEE --- */
        .marquee { width: 100%; background: var(--u-green); height: 50px; overflow: hidden; position: fixed; top: 0; z-index: 90000; display: flex; align-items: center; }
        .marquee-inner { display: flex; white-space: nowrap; animation: scroll 30s linear infinite; }
        .marquee-item { color: #000; font-weight: 900; text-transform: uppercase; font-size: 12px; padding: 0 50px; }
        @keyframes scroll { from { transform: translateX(0); } to { transform: translateX(-50%); } }

        /* --- NAVIGATION --- */
        .nav-container { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); width: 94%; z-index: 80000; }
        .nav-blur { background: rgba(10, 10, 10, 0.7); backdrop-filter: blur(25px); border: 1px solid var(--u-border); height: 85px; border-radius: 35px; display: flex; justify-content: space-between; align-items: center; padding: 0 35px; }

        /* --- PRODUCT CARDS --- */
        .product-card { 
            background: var(--u-card); border: 1px solid var(--u-border); border-radius: 45px; padding: 30px; 
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; align-items: center; position: relative;
        }
        .product-card:hover { 
            transform: translateY(-20px) scale(1.04); border-color: var(--u-green); 
            box-shadow: 0 40px 80px rgba(0,0,0,0.7), 0 0 30px rgba(34, 197, 94, 0.15); 
        }
        .img-container { width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 30px; margin-bottom: 25px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .img-container img { width: 100%; height: 100%; object-fit: contain; transition: transform 0.8s ease; }
        .product-card:hover img { transform: scale(1.25) rotate(5deg); }

        /* --- FAQ --- */
        .faq-item { background: #080808; border: 1px solid var(--u-border); border-radius: 25px; margin-bottom: 15px; cursor: pointer; transition: 0.3s; }
        .faq-question { padding: 25px; font-weight: 800; text-transform: uppercase; font-size: 14px; display: flex; justify-content: space-between; }
        .faq-answer { max-height: 0; overflow: hidden; padding: 0 25px; opacity: 0; transition: all 0.5s ease; color: rgba(255,255,255,0.5); }
        .faq-item.active .faq-answer { max-height: 200px; padding-bottom: 25px; opacity: 1; }

        /* --- CART SIDEBAR (DESIGN PROPRE) --- */
        #cart-sidebar { 
            position: fixed; top: 0; right: 0; width: 100%; max-width: 500px; height: 100%; background: #000; 
            z-index: 100000; display: none; flex-direction: column; border-left: 1px solid var(--u-border);
            animation: slideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #cart-sidebar.open { display: flex; }
        .cart-header { padding: 40px; border-bottom: 1px solid var(--u-border); display: flex; justify-content: space-between; align-items: center; }
        .cart-content { flex-grow: 1; overflow-y: auto; padding: 40px; }
        .cart-footer { padding: 40px; background: #050505; border-top: 1px solid var(--u-border); }

        /* --- ADMIN PANEL --- */
        #admin-view { position: fixed; inset: 0; background: #000; z-index: 1000000; display: none; overflow-y: auto; padding: 50px 20px; }
        .admin-box { background: #0a0a0a; border: 1px solid var(--u-border); border-radius: 35px; padding: 35px; margin-bottom: 25px; }

        /* --- UI ELEMENTS --- */
        .btn-green { width: 100%; background: var(--u-green); color: #000; padding: 22px; border-radius: 22px; font-weight: 900; font-style: italic; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        .btn-green:hover { transform: scale(0.98); animation: glow 2s infinite; }
        .input-dark { width: 100%; background: #0a0a0a; border: 1px solid var(--u-border); padding: 20px; border-radius: 20px; color: #fff; font-size: 14px; }

        /* --- RESPONSIVE GRID --- */
        .main-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 0 20px; width: 100%; max-width: 1400px; margin: 0 auto; }
        @media (min-width: 1024px) { .main-grid { grid-template-columns: repeat(4, 1fr); gap: 35px; } }
    </style>
</head>
<body>

    <div id="splash">
        <div class="splash-text text-white">UBER<span class="text-green-500">JNR</span></div>
        <div class="w-48 h-1 bg-white/5 mt-10 rounded-full overflow-hidden">
            <div id="splash-bar" class="h-full bg-green-500 w-0 transition-all duration-1000"></div>
        </div>
    </div>

    <div class="marquee">
        <div class="marquee-inner">
            <div class="marquee-item">‚ö° LIVRAISON EXPRESS TROYES ‚ö° 9 ACHET√âES = 1 OFFERTE ‚ö° NOUVEAUT√âS DISPO ‚ö°</div>
            <div class="marquee-item">‚ö° LIVRAISON EXPRESS TROYES ‚ö° 9 ACHET√âES = 1 OFFERTE ‚ö° NOUVEAUT√âS DISPO ‚ö°</div>
        </div>
    </div>

    <header class="nav-container">
        <div class="nav-blur">
            <div class="text-2xl font-900 italic">UBER<span class="text-green-500">JNR</span></div>
            <div class="flex items-center gap-4">
                <button onclick="checkAdmin()" class="bg-white/5 border border-white/10 px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-white/10 transition-all">Panel Admin</button>
                <button onclick="openModal('club-modal')" id="nav-btn-user" class="text-[10px] font-900 border border-white/10 px-5 py-3 rounded-2xl uppercase tracking-widest text-green-500">Espace Club</button>
                <button onclick="toggleCart(true)" class="relative bg-white/5 p-4 rounded-full border border-white/5">
                    <span class="text-xl">üõí</span>
                    <span id="badge-cart" class="absolute -top-1 -right-1 bg-green-500 text-[10px] w-6 h-6 flex items-center justify-center rounded-full text-black font-black">0</span>
                </button>
            </div>
        </div>
    </header>

    <section class="pt-[220px] pb-10 text-center px-4">
        <div id="shop-status-pill" class="inline-flex items-center px-6 py-2 rounded-full bg-white/5 border border-white/5 mb-8 text-[9px] font-black uppercase tracking-[0.2em]">
            <span class="w-2 h-2 bg-green-500 rounded-full mr-3"></span> Chargement...
        </div>

        <h1 class="text-7xl md:text-[10rem] font-900 italic leading-[0.85] mb-6">UBER<br><span class="text-green-500">JNR</span></h1>
        <p class="text-[11px] font-black opacity-20 uppercase tracking-[0.8em] mb-12">Premium Vape & Cloud Troyes</p>
        
        <div class="max-w-2xl mx-auto mb-20">
            <input type="text" id="search-input" oninput="drawProducts()" placeholder="RECHERCHER VOTRE SAVEUR..." class="input-dark text-center uppercase font-black tracking-widest py-6 border-white/10 focus:scale-105 transition-transform">
        </div>

        <div class="main-grid" id="grid-container"></div>
    </section>

    <section class="max-w-4xl mx-auto px-6 py-32 border-t border-white/5">
        <h2 class="text-4xl font-900 italic uppercase mb-16 text-center">Questions <span class="text-green-500">Fr√©quentes</span></h2>
        <div class="faq-item" onclick="this.classList.toggle('active')">
            <div class="faq-question">Comment commander ? <span>+</span></div>
            <div class="faq-answer">Ajoutez vos puffs au panier, remplissez vos infos et cliquez sur commander. Vous serez redirig√© vers notre WhatsApp pour confirmer l'heure de passage du livreur.</div>
        </div>
        <div class="faq-item" onclick="this.classList.toggle('active')">
            <div class="faq-question">Quels secteurs livrez-vous ? <span>+</span></div>
            <div class="faq-answer">Nous livrons Troyes et toute son agglom√©ration (Sainte-Savine, La Chapelle, Pont-Ste-Marie, etc.) en un temps record.</div>
        </div>
        <div class="faq-item" onclick="this.classList.toggle('active')">
            <div class="faq-question">Le programme 9+1 offert ? <span>+</span></div>
            <div class="faq-answer">Oui ! C'est automatique dans votre panier. D√®s 10 puffs ajout√©es, la moins ch√®re est offerte. Cumulez aussi des points club !</div>
        </div>
    </section>

    <footer class="py-20 border-t border-white/5 text-center px-6">
        <div class="text-5xl font-900 italic mb-4">UBER<span class="text-green-500">JNR</span></div>
        <p class="text-[11px] font-black opacity-20 uppercase tracking-widest mb-12">Premium Vape Store & Delivery Service</p>
        <div class="flex flex-wrap justify-center gap-8 mb-16">
            <a href="https://instagram.com/uber_jnr" target="_blank" class="text-[10px] font-black uppercase opacity-40 hover:text-green-500 tracking-widest">Instagram</a>
            <a href="https://snapchat.com/add/uber_jnr" target="_blank" class="text-[10px] font-black uppercase opacity-40 hover:text-green-500 tracking-widest">Snapchat</a>
            <a href="https://wa.me/33785141135" target="_blank" class="text-[10px] font-black uppercase opacity-40 hover:text-green-500 tracking-widest">WhatsApp</a>
        </div>
        <p class="text-[9px] opacity-10 uppercase font-black tracking-widest">¬© 2026 Uber Jnr Official Store</p>
    </footer>

    <div id="cart-sidebar">
        <div class="cart-header">
            <h2 class="text-3xl font-900 italic uppercase">Mon <span class="text-green-500">Panier</span></h2>
            <button onclick="toggleCart(false)" class="text-6xl opacity-20 hover:opacity-100 transition-opacity">&times;</button>
        </div>

        <div id="cart-list" class="cart-content space-y-6"></div>

        <div class="cart-footer space-y-6">
            <div class="flex justify-between items-end mb-4">
                <span class="text-[10px] font-black uppercase opacity-30">Total √† payer</span>
                <span id="cart-total" class="text-5xl font-900 text-green-500 italic">0.00‚Ç¨</span>
            </div>

            <div class="space-y-4">
                <input type="text" id="order-addr" placeholder="ADRESSE COMPLETE (N¬∞, RUE...)" class="input-dark uppercase font-bold">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="order-city" placeholder="VILLE" class="input-dark uppercase font-bold">
                    <input type="number" id="order-cp" placeholder="CODE POSTAL" class="input-dark uppercase font-bold">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-2">
                        <label class="text-[9px] font-black opacity-30 uppercase ml-2">Secteur</label>
                        <select id="order-zone" onchange="calcCartTotal()" class="input-dark font-black uppercase text-[11px] cursor-pointer">
                            <option value="Troyes">Troyes (Gratuit)</option>
                            <option value="Agglo">Agglo (+3.00‚Ç¨)</option>
                            <option value="Hors Agglo">Hors Agglo (+5.00‚Ç¨)</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[9px] font-black opacity-30 uppercase ml-2">Paiement</label>
                        <select id="order-pay" onchange="calcCartTotal()" class="input-dark font-black uppercase text-[11px] cursor-pointer">
                            <option value="Esp√®ces">Esp√®ces</option>
                            <option value="CB">CB (+0.50‚Ç¨)</option>
                        </select>
                    </div>
                </div>
            </div>

            <button onclick="validateOrder()" class="btn-green text-lg py-6 mt-4">Confirmer sur WhatsApp</button>
        </div>
    </div>

    <div id="club-modal" class="fixed inset-0 bg-black/98 z-[100001] hidden flex items-center justify-center p-6 backdrop-blur-xl">
        <div class="bg-black border border-white/10 p-12 rounded-[50px] max-w-md w-full relative">
            <button onclick="closeModal('club-modal')" class="absolute top-8 right-8 text-3xl opacity-20">&times;</button>
            <div id="club-auth" class="space-y-8">
                <div class="text-center">
                    <h3 class="text-3xl font-900 uppercase italic">Uber Jnr <span class="text-green-500">Club</span></h3>
                    <p class="text-[10px] font-black opacity-20 uppercase mt-2 tracking-widest">Fid√©lit√© & Privil√®ges</p>
                </div>
                <div class="space-y-4">
                    <input type="email" id="auth-email" placeholder="VOTRE EMAIL" class="input-dark">
                    <input type="password" id="auth-pass" placeholder="MOT DE PASSE" class="input-dark">
                    <button onclick="login()" class="btn-green">Se Connecter</button>
                    <button onclick="register()" class="w-full text-[10px] font-black opacity-20 uppercase tracking-[0.3em] py-4">Cr√©er un compte</button>
                </div>
            </div>
            <div id="club-profile" class="hidden text-center space-y-10">
                <h3 id="profile-name" class="text-4xl font-900 text-green-500 italic uppercase">...</h3>
                <div id="profile-points" class="grid grid-cols-5 gap-3"></div>
                <div class="bg-white/5 p-8 rounded-[35px] space-y-4 border border-white/5">
                    <p class="text-[10px] font-black text-green-500 uppercase tracking-[0.2em]">Votre lien de parrainage</p>
                    <button onclick="copyRefLink()" class="btn-green !py-4 !text-[10px]">COPIER MON LIEN</button>
                </div>
                <button onclick="logout()" class="text-red-500 text-[10px] font-black uppercase underline opacity-30">D√©connexion</button>
            </div>
        </div>
    </div>

    <div id="admin-view">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-16 px-4">
                <h2 class="text-5xl font-900 italic uppercase">Admin<span class="text-green-500">Board</span></h2>
                <div class="flex gap-4">
                    <button id="adm-store-toggle" onclick="toggleStoreStatus()" class="px-8 py-4 rounded-2xl font-black text-[10px] uppercase border transition-all"></button>
                    <button onclick="closeAdmin()" class="text-6xl text-white/20">&times;</button>
                </div>
            </div>

            <div class="grid md:grid-cols-4 gap-6 mb-12 px-4">
                <div class="admin-box text-center">
                    <p class="text-[10px] font-black opacity-30 uppercase">Chiffre d'Affaire</p>
                    <div id="stat-ca" class="text-3xl font-900 text-green-500 mt-2">0.00‚Ç¨</div>
                </div>
                <div class="admin-box text-center">
                    <p class="text-[10px] font-black opacity-30 uppercase">Marge Nette (Est.)</p>
                    <div id="stat-marge" class="text-3xl font-900 text-blue-500 mt-2">0.00‚Ç¨</div>
                </div>
                <div class="admin-box text-center">
                    <p class="text-[10px] font-black opacity-30 uppercase">Volume Puffs</p>
                    <div id="stat-vol" class="text-3xl font-900 text-orange-500 mt-2">0</div>
                </div>
                <div class="admin-box text-center">
                    <p class="text-[10px] font-black opacity-30 uppercase">Membres Club</p>
                    <div id="stat-users" class="text-3xl font-900 text-purple-500 mt-2">0</div>
                </div>
            </div>

            <div class="grid lg:grid-cols-2 gap-10 px-4">
                <div class="admin-box space-y-8">
                    <h3 class="text-xs font-black text-green-500 uppercase tracking-widest">Inventaire & Stock</h3>
                    <div class="space-y-4">
                        <input type="text" id="adm-pname" placeholder="NOM DU PRODUIT" class="input-dark">
                        <div class="h-32 border-2 border-dashed border-white/10 rounded-3xl flex flex-col items-center justify-center relative">
                            <span id="adm-img-status" class="text-[10px] font-black opacity-20 uppercase">Image du produit</span>
                            <input type="file" onchange="uploadImage(this)" class="absolute inset-0 opacity-0 cursor-pointer">
                            <input type="hidden" id="adm-pimg">
                        </div>
                        <input type="number" id="adm-pstock" placeholder="QUANTIT√â EN STOCK" class="input-dark">
                        <button onclick="addProduct()" class="btn-green">Ajouter au catalogue</button>
                    </div>
                    <div id="adm-stock-list" class="pt-10 space-y-4"></div>
                </div>

                <div class="admin-box space-y-8">
                    <h3 class="text-xs font-black text-purple-500 uppercase tracking-widest">Gestion des Membres</h3>
                    <div id="adm-users-list" class="space-y-4"></div>
                    <h3 class="text-xs font-black text-blue-500 uppercase tracking-widest pt-10">Flux Commandes</h3>
                    <div id="adm-orders-list" class="space-y-4 max-h-[500px] overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <audio id="order-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <script>
        const WA_PHONE = "33785141135";
        const IMGBB_API = "c90dd571e5bac1d3d004064dab67b8eb";
        
        let inventory = [], users = [], orders = [], cart = [], currentUser = null;
        let isStoreOpen = true;

        window.addEventListener('firebase-ready', () => {
            // SYNC STORE STATUS
            fb.onValue(fb.ref(db, 'storeStatus'), snap => {
                isStoreOpen = snap.val() !== null ? snap.val() : true;
                updateStoreUI();
            });

            // SYNC INVENTORY
            fb.onValue(fb.ref(db, 'inventory'), snap => {
                inventory = snap.val() ? Object.values(snap.val()) : [];
                drawProducts();
                renderAdminInventory();
            });

            // SYNC USERS
            fb.onValue(fb.ref(db, 'users'), snap => {
                users = snap.val() ? Object.values(snap.val()) : [];
                renderAdminUsers();
                updateStats();
                if(currentUser) {
                    currentUser = users.find(u => u.email === currentUser.email);
                    updateProfileUI();
                }
            });

            // SYNC ORDERS
            fb.onValue(fb.ref(db, 'orders'), snap => {
                const oldLen = orders.length;
                orders = snap.val() ? Object.values(snap.val()) : [];
                if(orders.length > oldLen && oldLen !== 0) {
                    document.getElementById('order-sound').play();
                }
                updateStats();
                renderAdminOrders();
            });

            // SESSION CLIENT
            const s = localStorage.getItem('ujnr_v9');
            if(s) { currentUser = JSON.parse(s); updateProfileUI(); }

            // SPLASH EXIT
            setTimeout(() => {
                document.getElementById('splash-bar').style.width = "100%";
                setTimeout(() => {
                    document.getElementById('splash').style.opacity = "0";
                    setTimeout(() => document.getElementById('splash').style.display = "none", 1000);
                }, 1000);
            }, 500);
        });

        // --- FONCTION ADMIN (SOUVENIR DE L'APPAREIL) ---
        function checkAdmin() {
            // On v√©rifie si une session admin existe d√©j√† sur cet appareil
            const isAuth = localStorage.getItem('uberjnr_admin_session');
            
            if (isAuth === 'true') {
                document.getElementById('admin-view').style.display = 'block';
            } else {
                const code = prompt("CODE ACC√àS ADMIN :");
                if (code === "Zendor22.") {
                    localStorage.setItem('uberjnr_admin_session', 'true');
                    document.getElementById('admin-view').style.display = 'block';
                }
            }
        }

        function closeAdmin() { document.getElementById('admin-view').style.display = 'none'; }

        // --- CATALOGUE & PANIER ---
        function drawProducts() {
            const grid = document.getElementById('grid-container');
            const search = document.getElementById('search-input').value.toLowerCase();
            grid.innerHTML = "";
            
            inventory.filter(p => p.name.toLowerCase().includes(search)).forEach(p => {
                const out = p.stock <= 0;
                grid.innerHTML += `
                    <div class="product-card">
                        ${out ? '<div class="absolute top-8 left-8 bg-red-600 text-[9px] font-black px-5 py-2 rounded-full z-10 shadow-lg">√âPUIS√â</div>' : ''}
                        <div class="img-container">
                            <img src="${p.img}" class="${out ? 'grayscale opacity-30' : ''}" loading="lazy">
                        </div>
                        <h4 class="text-[14px] font-900 uppercase tracking-widest text-center h-14 flex items-center mb-6 px-4">${p.name}</h4>
                        <div class="text-green-500 font-900 text-3xl italic mb-8">10.00‚Ç¨</div>
                        <button onclick="addToCart('${p.id}')" class="btn-green !py-5" ${out ? 'disabled opacity-20' : ''}>
                            ${out ? 'RUPTURE' : 'AJOUTER'}
                        </button>
                    </div>
                `;
            });
        }

        function toggleCart(show) { document.getElementById('cart-sidebar').classList.toggle('open', show); }
        
        function addToCart(id) {
            const p = inventory.find(i => i.id === id);
            if(p && p.stock > 0) {
                cart.push(p);
                updateCartUI();
                if(navigator.vibrate) navigator.vibrate(50);
            }
        }

        function updateCartUI() {
            const list = document.getElementById('cart-list');
            document.getElementById('badge-cart').innerText = cart.length;
            list.innerHTML = "";
            
            if(cart.length === 0) {
                list.innerHTML = `<div class="h-full flex items-center justify-center opacity-10 uppercase font-black tracking-widest text-xs">Votre panier est vide</div>`;
            } else {
                cart.forEach((p, i) => {
                    list.innerHTML += `
                        <div class="flex justify-between items-center bg-white/5 p-6 rounded-[30px] border border-white/5">
                            <div class="flex items-center gap-5">
                                <img src="${p.img}" class="w-16 h-16 rounded-2xl object-cover">
                                <div>
                                    <p class="text-[12px] font-900 uppercase">${p.name}</p>
                                    <p class="text-[10px] text-green-500 font-black mt-1">10.00‚Ç¨</p>
                                </div>
                            </div>
                            <button onclick="removeFromCart(${i})" class="text-red-500 text-[10px] font-black uppercase p-2">Retirer</button>
                        </div>
                    `;
                });
            }
            calcCartTotal();
        }

        function removeFromCart(i) { cart.splice(i, 1); updateCartUI(); }

        function calcCartTotal() {
            let total = cart.length * 10;
            let packs = Math.floor(cart.length / 10);
            total -= (packs * 10);
            const zone = document.getElementById('order-zone').value;
            const pay = document.getElementById('order-pay').value;
            if(zone === "Agglo") total += 3;
            if(zone === "Hors Agglo") total += 5;
            if(pay === "CB") total += 0.50;
            document.getElementById('cart-total').innerText = total.toFixed(2) + "‚Ç¨";
        }

        function validateOrder() {
            const addr = document.getElementById('order-addr').value;
            const city = document.getElementById('order-city').value;
            const cp = document.getElementById('order-cp').value;
            if(!addr || !city || !cp || cart.length === 0) return alert("Remplissez tout !");

            const oid = "UBR-" + Math.random().toString(36).substr(2, 6).toUpperCase();
            const totalVal = document.getElementById('cart-total').innerText;
            
            const order = {
                id: oid,
                email: currentUser ? currentUser.email : "INVIT√â",
                items: cart.map(c => c.name).join(", "),
                qty: cart.length,
                total: parseFloat(totalVal),
                address: `${addr.toUpperCase()}, ${cp} ${city.toUpperCase()}`,
                timestamp: Date.now()
            };

            fb.set(fb.ref(db, 'orders/' + oid), order);

            // Baisse de stock auto
            cart.forEach(item => {
                const cur = inventory.find(i => i.id === item.id).stock;
                fb.update(fb.ref(db, 'inventory/' + item.id), { stock: cur - 1 });
            });

            const msg = `‚ö° *COMMANDE UBER JNR*\nID: ${oid}\nCLIENT: ${order.email}\nPUFFS: ${order.items}\nADRESSE: ${order.address}\nTOTAL: ${totalVal}`;
            window.open(`https://wa.me/${WA_PHONE}?text=${encodeURIComponent(msg)}`);
            cart = []; updateCartUI(); toggleCart(false);
        }

        // --- CLUB ---
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function register() {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-pass').value;
            if(!e.includes('@')) return alert("Email invalide.");
            const uid = btoa(e).replace(/=/g, "");
            fb.set(fb.ref(db, 'users/' + uid), { email: e, pass: p, pts: 0 });
            alert("Compte cr√©√© !");
        }

        function login() {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-pass').value;
            const u = users.find(x => x.email === e && x.pass === p);
            if(u) {
                currentUser = u;
                localStorage.setItem('ujnr_v9', JSON.stringify(u));
                updateProfileUI();
            } else alert("Erreur.");
        }

        function updateProfileUI() {
            document.getElementById('club-auth').classList.add('hidden');
            document.getElementById('club-profile').classList.remove('hidden');
            document.getElementById('profile-name').innerText = currentUser.email.split('@')[0].toUpperCase();
            document.getElementById('nav-btn-user').innerText = currentUser.email.split('@')[0].toUpperCase();
            const uOrders = orders.filter(o => o.email === currentUser.email);
            const totalPuffs = uOrders.reduce((acc, curr) => acc + curr.qty, 0);
            const pts = (totalPuffs + (currentUser.pts || 0)) % 10;
            const box = document.getElementById('profile-points');
            box.innerHTML = "";
            for(let i=1; i<=10; i++) {
                box.innerHTML += `<div class="h-4 rounded-full ${i <= pts ? 'bg-green-500 shadow-[0_0_15px_#22c55e]' : 'bg-white/5'} transition-all duration-700"></div>`;
            }
        }

        function copyRefLink() {
            const link = "https://uber-jnr.fr/?ref=" + btoa(currentUser.email).substr(0, 8);
            navigator.clipboard.writeText(link).then(() => alert("Copi√© !"));
        }

        function logout() { localStorage.removeItem('ujnr_v9'); location.reload(); }

        // --- ADMIN ENGINE ---
        async function uploadImage(input) {
            const file = input.files[0];
            if(!file) return;
            document.getElementById('adm-img-status').innerText = "CHARGEMENT...";
            const fd = new FormData(); fd.append("image", file);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API}`, { method: "POST", body: fd });
                const d = await res.json();
                if(d.success) {
                    document.getElementById('adm-pimg').value = d.data.url;
                    document.getElementById('adm-img-status').innerText = "IMAGE OK ‚úÖ";
                }
            } catch(e) { alert("Erreur."); }
        }

        function addProduct() {
            const n = document.getElementById('adm-pname').value;
            const i = document.getElementById('adm-pimg').value;
            const s = document.getElementById('adm-pstock').value;
            if(n && i) {
                const pid = "P-" + Date.now();
                fb.set(fb.ref(db, 'inventory/' + pid), { id: pid, name: n.toUpperCase(), img: i, stock: parseInt(s) });
                alert("Ajout√© !");
            }
        }

        function renderAdminInventory() {
            const list = document.getElementById('adm-stock-list');
            list.innerHTML = "";
            inventory.forEach(p => {
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-white/5 p-5 rounded-3xl border border-white/5">
                        <span class="text-[11px] font-black uppercase">${p.name} <span class="text-green-500">[${p.stock}]</span></span>
                        <div class="flex gap-3">
                            <button onclick="modStock('${p.id}', 1)" class="w-10 h-10 bg-green-500/10 text-green-500 rounded-xl">+</button>
                            <button onclick="modStock('${p.id}', -1)" class="w-10 h-10 bg-red-500/10 text-red-500 rounded-xl">-</button>
                            <button onclick="delProd('${p.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
        }

        function modStock(id, n) {
            const p = inventory.find(x => x.id === id);
            fb.update(fb.ref(db, 'inventory/' + id), { stock: Math.max(0, p.stock + n) });
        }

        function delProd(id) { if(confirm("Supprimer ?")) fb.remove(fb.ref(db, 'inventory/' + id)); }

        function renderAdminUsers() {
            const list = document.getElementById('adm-users-list');
            list.innerHTML = "";
            users.forEach(u => {
                const uid = btoa(u.email).replace(/=/g, "");
                list.innerHTML += `
                    <div class="bg-white/5 p-6 rounded-[30px] border border-white/5 space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-[12px] font-black uppercase text-purple-400">${u.email}</span>
                            <button onclick="deleteUser('${uid}')" class="text-red-500 text-[9px] font-black uppercase">Supprimer</button>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] opacity-40 font-black">Points: ${u.pts || 0}</span>
                            <div class="flex gap-2">
                                <button onclick="modPts('${uid}', 1)" class="w-8 h-8 bg-green-500/20 text-green-500 rounded-lg">+</button>
                                <button onclick="modPts('${uid}', -1)" class="w-8 h-8 bg-red-500/20 text-red-500 rounded-lg">-</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function modPts(uid, n) {
            const u = users.find(x => btoa(x.email).replace(/=/g, "") === uid);
            fb.update(fb.ref(db, 'users/' + uid), { pts: (u.pts || 0) + n });
        }

        function deleteUser(uid) { if(confirm("Supprimer ?")) fb.remove(fb.ref(db, 'users/' + uid)); }

        function toggleStoreStatus() { fb.set(fb.ref(db, 'storeStatus'), !isStoreOpen); }

        function updateStoreUI() {
            const pill = document.getElementById('shop-status-pill');
            const btn = document.getElementById('adm-store-toggle');
            if(isStoreOpen) {
                pill.innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full mr-3 animate-pulse"></span>OUVERT`;
                btn.innerText = "FERMER LE STORE";
            } else {
                pill.innerHTML = `<span class="w-2 h-2 bg-red-500 rounded-full mr-3"></span>FERM√â`;
                btn.innerText = "OUVRIR LE STORE";
            }
        }

        function updateStats() {
            let ca = 0, vol = 0;
            orders.forEach(o => { ca += o.total; vol += o.qty; });
            document.getElementById('stat-ca').innerText = ca.toFixed(2) + "‚Ç¨";
            document.getElementById('stat-marge').innerText = (ca * 0.45).toFixed(2) + "‚Ç¨";
            document.getElementById('stat-vol').innerText = vol;
            document.getElementById('stat-users').innerText = users.length;
        }

        function renderAdminOrders() {
            const list = document.getElementById('adm-orders-list');
            list.innerHTML = "";
            [...orders].reverse().slice(0, 20).forEach(o => {
                list.innerHTML += `
                    <div class="bg-black p-5 rounded-3xl border border-white/5">
                        <div class="flex justify-between text-[10px] font-black text-blue-400">
                            <span>${o.id}</span>
                            <span>${o.total.toFixed(2)}‚Ç¨</span>
                        </div>
                        <p class="text-[12px] font-bold uppercase mt-3">${o.items}</p>
                        <p class="text-[9px] opacity-30 mt-2">${o.address}</p>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>

